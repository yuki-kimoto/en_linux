<h2>OpenSSHの導入 | Perl環境構築</h2>



(CentOS5.7で確認)

##OpenSSHサーバの導入
　SSHは安全なリモートログインを実現するサービスで、telnetのセキュリティ強化バージョンにあたります。SSHを利用すると通信に利用されるデータを暗号化することができます。SSHのためのサーバとして、OpenSSHというものがあります。

　以下の３つのパッケージが必要になります。

-openssh ( SSH接続のためのクライアントソフト )
-openssh-server ( SSH接続を受け付けるサーバ )
-openssl ( SSHの暗号化部分の実装であるSSLのためのソフトウェア )

##インストール
　以下のコマンドでインストールできます。
```
yum -y install openssh
yum -y install openssh-server
yum -y install openssl
```

##インストールの確認
　rpmコマンドで上記３つのパッケージが含まれているかを確認します。
```
rpm -q openssh
rpm -q openssh-server
rpm -q openssl
```

##サービス起動スクリプト
　サービス起動スクリプトを見ればいろいろな情報がわかります。

```
# サービス起動スクリプトを見る。
view /etc/init.d/sshd
```

##サービスの自動起動の設定
　自動起動の設定を確認する。
```
# 自動起動の確認
chkconfig --list sshd

# ランレベル2345がonになっていない場合はonにする。(サービス起動スクリプトに推奨されるランレベルの記述がある。)
chkconfig --level 2345 sshd on

# サービスそのものとして登録されていない場合は追加する。
chkconfig --add sshd
```

##サービスの開始・停止・確認
```
# サービスが開始しているかどうかの確認
service sshd status

# 開始していない場合は開始
service sshd start

# 停止する場合は
service sshd stop
```

##設定ファイル
###sshdの設定ファイル
```
/etc/ssh/sshd_config
```

##設定ファイルでのセキュリティ上の考慮

###SSHのバージョンには2のみを使用する。
　以下のようになっていることを確認。SSH1 にはセキュリティホールがあり、SSH2のみを使うようにする。
```
Protocol 2
```

###rootでの直接的なログインを禁止する
　rootで直接ログインできた場合、複数の管理者がいると、誰がrootで操作したのかが把握できなくなるのでrootログインを禁止します。
```
PermitRootLogin no
```

###sshdのセキュリティに関するログ
　デフォルトだと
```
/var/log/secure
```
に出力されるようです。

##アクセス制御設定ファイルの編集

　特定のIPアドレスだけからのアクセスを許可するようにします。

###/etc/hosts.deny
　まずsshdへのアクセスをすべて拒否する。
```
sshd: ALL
```

###/etc/hosts.allow

　必要なものだけアクセスを許可する(必要に応じて設定)。

```
# (例)192.168.1.0 ～ 192.168.1.255 までを許可
sshd: 192.168.1.
```

##公開鍵の作成

　公開鍵はサーバ側ではなく、クライアント側で作成して、サーバ側に移動させます。クライアント側での鍵の作成も別途必要になります。

##ログインユーザのホームディレクトリに公開鍵を設置
　クライアント側での公開鍵の作成作業が終われば、再びサーバ側での作業です。まず、自分のIDでサーバにログインします。

　まず、.sshというディレクトリをユーザのホームディレクトリに作成します。( ~ はユーザのホームディレクトリを指します)

```
mkdir ~/.ssh
```

　確認するには

```
ls -a
```

とします。(.で始まるファイルは ls では見れないため )

ここに、アップロードした公開鍵を移動しておきます。(公開鍵はホームディレクトリにアップロードしていると想定します。)

```
mv ~/id_dsa.pub ~/.ssh
```

　その後ログインユーザのホームディレクトリの .ssh/authorized_keys というファイルに、アップロードした公開鍵を追加書き込みします。

```
# authorized_keysファイルの作成
touch ~/.ssh/authorized_keys

# authorized_keysファイルに追加書き込み
cat ~/.ssh/id_dsa.pub >> ~/.ssh/authorized_keys

# .sshディレクトリとauthorized_keysの書き込み権限はユーザだけにしておく
# (こうしないとセキュリティ上の理由で接続できない)
chmod 755 ~/.ssh
chmod 644 ~/.ssh/authorized_keys

#確認( 所有者はログインユーザで、パーミッションが上記のとおりになっていることを確認)
# .sshディレクトリの確認( drwxr-xr-x )
ls -al ~/

# authorized_keysの確認( -rw-r--r-- )
ls -al ~/.ssh/authorized_keys
```

##sshd_configの設定変更
　設定ファイルは
```
/etc/ssh/sshd_config
```
です。

　おそらく、以下の行がコメントアウトされているので # を消します。
　公開鍵認証できるようにする設定と、公開鍵情報のファイルの設定です。

```
#PubkeyAuthentication yes
#AuthorizedKeysFile     .ssh/authorized_keys
```
↓
```
PubkeyAuthentication yes
AuthorizedKeysFile     .ssh/authorized_keys
```

　公開鍵認証ができるようになったので、パスワード認証ができないようにしておきます。

```
PasswordAuthentication yes
```
↓
```
PasswordAuthentication no
```

　設定を反映されるためsshdを再起動

```
service sshd restart
```

##クライアント側からの接続
　ここまでの作業を終えればクライアント側からSSH接続ができます。
