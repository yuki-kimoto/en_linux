<h2>OpenSSHの導入</h2>



(CentOS5.7で確認)

<h3>OpenSSHサーバの導入</h3>
　SSHは安全なリモートログインを実現するサービスで、telnetのセキュリティ強化バージョンにあたります。SSHを利用すると通信に利用されるデータを暗号化することができます。SSHのためのサーバとして、OpenSSHというものがあります。

　以下の３つのパッケージが必要になります。

-openssh ( SSH接続のためのクライアントソフト )
-openssh-server ( SSH接続を受け付けるサーバ )
-openssl ( SSHの暗号化部分の実装であるSSLのためのソフトウェア )

<h3>インストール</h3>
　以下のコマンドでインストールできます。
<pre>
yum -y install openssh
yum -y install openssh-server
yum -y install openssl
</pre>

<h3>インストールの確認</h3>
　rpmコマンドで上記３つのパッケージが含まれているかを確認します。
<pre>
rpm -q openssh
rpm -q openssh-server
rpm -q openssl
</pre>

<h3>サービス起動スクリプト</h3>
　サービス起動スクリプトを見ればいろいろな情報がわかります。

<pre>
<h3> サービス起動スクリプトを見る。</h3>
view /etc/init.d/sshd
</pre>

<h3>サービスの自動起動の設定</h3>
　自動起動の設定を確認する。
<pre>
<h3> 自動起動の確認</h3>
chkconfig --list sshd

<h3> ランレベル2345がonになっていない場合はonにする。(サービス起動スクリプトに推奨されるランレベルの記述がある。)</h3>
chkconfig --level 2345 sshd on

<h3> サービスそのものとして登録されていない場合は追加する。</h3>
chkconfig --add sshd
</pre>

<h3>サービスの開始・停止・確認</h3>
<pre>
<h3> サービスが開始しているかどうかの確認</h3>
service sshd status

<h3> 開始していない場合は開始</h3>
service sshd start

<h3> 停止する場合は</h3>
service sshd stop
</pre>

<h3>設定ファイル</h3>
<h4>sshdの設定ファイル</h4>
<pre>
/etc/ssh/sshd_config
</pre>

<h3>設定ファイルでのセキュリティ上の考慮</h3>

<h4>SSHのバージョンには2のみを使用する。</h4>
　以下のようになっていることを確認。SSH1 にはセキュリティホールがあり、SSH2のみを使うようにする。
<pre>
Protocol 2
</pre>

<h4>rootでの直接的なログインを禁止する</h4>
　rootで直接ログインできた場合、複数の管理者がいると、誰がrootで操作したのかが把握できなくなるのでrootログインを禁止します。
<pre>
PermitRootLogin no
</pre>

<h4>sshdのセキュリティに関するログ</h4>
　デフォルトだと
<pre>
/var/log/secure
</pre>
に出力されるようです。

<h3>アクセス制御設定ファイルの編集</h3>

　特定のIPアドレスだけからのアクセスを許可するようにします。

<h4>/etc/hosts.deny</h4>
　まずsshdへのアクセスをすべて拒否する。
<pre>
sshd: ALL
</pre>

<h4>/etc/hosts.allow</h4>

　必要なものだけアクセスを許可する(必要に応じて設定)。

<pre>
<h3> (例)192.168.1.0 ～ 192.168.1.255 までを許可</h3>
sshd: 192.168.1.
</pre>

<h3>公開鍵の作成</h3>

　公開鍵はサーバ側ではなく、クライアント側で作成して、サーバ側に移動させます。クライアント側での鍵の作成も別途必要になります。

<h3>ログインユーザのホームディレクトリに公開鍵を設置</h3>
　クライアント側での公開鍵の作成作業が終われば、再びサーバ側での作業です。まず、自分のIDでサーバにログインします。

　まず、.sshというディレクトリをユーザのホームディレクトリに作成します。( ~ はユーザのホームディレクトリを指します)

<pre>
mkdir ~/.ssh
</pre>

　確認するには

<pre>
ls -a
</pre>

とします。(.で始まるファイルは ls では見れないため )

ここに、アップロードした公開鍵を移動しておきます。(公開鍵はホームディレクトリにアップロードしていると想定します。)

<pre>
mv ~/id_dsa.pub ~/.ssh
</pre>

　その後ログインユーザのホームディレクトリの .ssh/authorized_keys というファイルに、アップロードした公開鍵を追加書き込みします。

<pre>
<h3> authorized_keysファイルの作成</h3>
touch ~/.ssh/authorized_keys

<h3> authorized_keysファイルに追加書き込み</h3>
cat ~/.ssh/id_dsa.pub >> ~/.ssh/authorized_keys

<h3> .sshディレクトリとauthorized_keysの書き込み権限はユーザだけにしておく</h3>
<h3> (こうしないとセキュリティ上の理由で接続できない)</h3>
chmod 755 ~/.ssh
chmod 644 ~/.ssh/authorized_keys

<h3>確認( 所有者はログインユーザで、パーミッションが上記のとおりになっていることを確認)</h3>
<h3> .sshディレクトリの確認( drwxr-xr-x )</h3>
ls -al ~/

<h3> authorized_keysの確認( -rw-r--r-- )</h3>
ls -al ~/.ssh/authorized_keys
</pre>

<h3>sshd_configの設定変更</h3>
　設定ファイルは
<pre>
/etc/ssh/sshd_config
</pre>
です。

　おそらく、以下の行がコメントアウトされているので # を消します。
　公開鍵認証できるようにする設定と、公開鍵情報のファイルの設定です。

<pre>
<h3>PubkeyAuthentication yes</h3>
<h3>AuthorizedKeysFile     .ssh/authorized_keys</h3>
</pre>
↓
<pre>
PubkeyAuthentication yes
AuthorizedKeysFile     .ssh/authorized_keys
</pre>

　公開鍵認証ができるようになったので、パスワード認証ができないようにしておきます。

<pre>
PasswordAuthentication yes
</pre>
↓
<pre>
PasswordAuthentication no
</pre>

　設定を反映されるためsshdを再起動

<pre>
service sshd restart
</pre>

<h3>クライアント側からの接続</h3>
　ここまでの作業を終えればクライアント側からSSH接続ができます。
