<h2>MySQLのインストール・ユーザー管理</h2>


##MySQLのインストール

(CentOS5.7で確認)

　MySQLとはフリーのリレーショナルデータベースシステム(RDBS)のひとつです。非常に高速に動作することが特徴です。

###MySQLのパッケージ

　以下の4つのパッケージをインストールします。MySQLはクライアント・サーバ型のアプリケーションです。SQLを受け付けてデータを返却するのがサーバで、SQLで問い合わせを行うのがクライアントです。またプログラムの中からMySQLに接続することも可能です。

```
# MySQLのサーバ
mysql-server

# MySQLのクライアント
mysql

# MySQLのライブラリ
mysql-devel
```

###インストール

　以下のコマンドでインストールできます。

```
yum -y install mysql-server
yum -y install mysql
yum -y install mysql-devel
```

###インストールの確認

　rpmコマンドでパッケージがインストールされたかを確認します。

```
rpm -q mysql-server
rpm -q mysql
rpm -q mysql-devel
```

###サービス起動スクリプト

　サービス起動スクリプトを見ればいろいろな情報がわかります。

```
# サービス起動スクリプトを見る。
view /etc/init.d/mysqld
```

###サービスの自動起動の設定

　自動起動の設定を確認する。

```
# 自動起動の確認
chkconfig --list mysqld

# 自動起動をonにする
chkconfig mysqld on

# サービスそのものとして登録されていない場合は追加する。
chkconfig --add mysqld
```

###サービスの開始・停止・確認

```
# サービスが開始しているかどうかの確認
service mysqld status

# 開始していない場合は開始
service mysqld start

# 停止する場合は
service mysqld stop
```

###MySQLのバージョン確認

```
mysqladmin version
```

###MySQLの設定ファイル

```
view /etc/my.cnf;
```

###MySQLのログファイル

```
view /var/log/mysqld.log
```

###接続確認

　mysqlとコマンドを打って接続できれば完了です。

```
mysql
```

##データベースの作成、テーブルの作成

　MySQLのインストールが終われば、データベースやテーブルを作成することができます。MySQLは複数のデータベースを持つことができます。データベースは複数のテーブルを含むことができます。

###データベースの作成

```
mysql
```

　MySQLのクライアントをたち上げて、

```
create database データベース名;
```

とするとデータベースを作成することができます。SQLのコマンドの最後にはセミコロン( ; ) を忘れないようにします。

　データベースの一覧を見るには、

```
show databases;
```

とします。

データベースを削除したい場合は

```
drop database データベース名;
```

とします。データベースを削除すると、その中に含まれるテーブルがすべて削除されるので、注意します。

###テーブルの作成の準備。データベースの選択

　テーブルを作成するには、まずデータベースを選択する必要があります。データベースを選択するには、mysqlを起動するときに

```
mysql データベース名
```

とするか、mysqlを起動してから、

```
use データベース名;
```

とします。

データベースが選択されていれば、テーブルを作成することができます。

###テーブルの作成

　テーブルというのは、excelの表に似ています。各列が列名を持っていて、各行にはデータが入ります。

```
name   | age | country 
kimoto | 28  | japan
Ken    | 14  | USA
```

　この例では、列名は、name, age, country です。各行には、( kimoto, 28, japan ) ( Ken, 14, USA )というデータが入っています。

　テーブルを作成するには、create table 文を使います。また、列名とデータ型を指定する必要があります。構文は、

```
create table テーブル名(
  列名 型,
  列名 型,
  ...
);
```

です。

　サンプルを書いておきます。nameとcountryは可変文字列型(varcharで最大255文字)、年齢はint型にしておきます。
```
create table person(
  name varchar(255),
  age int,
  country varchar(255)
);
```

　テーブルの一覧を表示するには、

```
show tables;
```

とします。

　テーブルの定義を見るには、

```
desc テーブル名;
```

あるいは、

```
describe テーブル名;
```
とします。

　テーブルを削除するには、

```
drop table テーブル名;
```

とします。

##MySQL ユーザの作成・パスワードの設定

###ユーザ名とパスワード

　通常MySQLサーバに接続する場合は、ユーザ名とパスワードを指定して接続します。

```
mysql --user=kimoto --password=honyarara
```

あるいは、

```
mysql -u kimoto -phonyarara
```

(-pとパスワードの間は空けないことに注意)

　MySQLをインストールした直後であれば、

```
mysql
```

とコマンドを打つだけで、MySQLサーバに接続することができます。ユーザ名を与えない場合は、ログインユーザ名を与えて、mysqlサーバに接続し、パスワードが初期状態では設定されていないためです。

　ログインユーザとMySQLのユーザはまったく別物です。MySQLにログインユーザとしてはログインできません。kimotoというログインユーザがいても、mysqlサーバにkimotoというユーザで接続できるわけではありません。

###ユーザを作成する意味

　rootユーザにはすべての権限が与えられています。MySQLのデータベースを利用する人の多くは、テーブルにあるデータを操作したり取得したいだけです。また特定のユーザに特定のデータベースに対する操作を許可するということもできます。データベースを利用する人のためにユーザを作成して、適切な権限を与えることができます。

###クライアントのホスト名

　MySQLのユーザ管理には、そのユーザがどこから接続したかということが含まれます。たとえば、ローカルからkimotoで接続した場合とリモート(たとえばデータベースサーバとアプリケーションサーバが別にある場合など)から接続した場合では、異なるユーザとして扱われます。

　ローカルで接続した場合のユーザ名は、

```
kimoto@localhost
```

のようになります。

　www.honyara.comというホスト名を持つサーバから接続した場合は、

```
kimoto@www.honyara.com
```

というユーザ名になります。この辺がMySQLのユーザ管理で少しわかりにくい部分です。「ユーザ名」@「どこから接続しているか」が、本当のユーザ名であると覚えておきましょう。

###rootユーザのパスワードの設定

　まずデフォルトではrootユーザにパスワードがありませんから、パスワードを設定します。rootというのは、本当のユーザ名ではありません。root@localhostというのが、本当のユーザ名ですので、これに対してパスワードを設定します。

```
mysql
```

で接続して、

```
set password for root@localhost = password('パスワード');
```

とします。後ろの方のpassword('パスワード')はpassword関数で、暗号化されたパスワードを作成しています。

```
select user,host,password from mysql.user;
```

とコマンドを打ってみましょう。アカウント情報を見ることができます。uesr(ユーザ名)がrootで、ホスト名が「localhost.localdomain」や「127.0.0.1」などのlocalhostと同じものを意味するユーザに対しても同じパスワード設定しておく必要があるようです。(理由はよくわかりません)

```
set password for root@127.0.0.1 = password('パスワード');
set password for root@localhost.localdomain = password('パスワード');
```

###紛らわしい引数 --host

　mysqlコマンドで、

```
mysql --host=some.remote.com --user=kimoto --passwrod=pekepeke
```

とホスト名を指定することがありますが、このホスト名は接続先のホスト名の指定になります。MySQLはTCP/IP接続でリモートのMySQLサーバに接続することができ、リモート接続したい場合に、--hostでホスト名を指定します。

　上で解説したアカウント管理のホスト名はクライアント(接続元)のホスト名ですのこんがらがらないようにしましょう。

###ユーザを追加する構文

　ユーザの追加のコマンドはわかりにくです。ユーザを追加するというと、adduser見たいなコマンドを思い浮かべるかもしれませんが違います。

　MySQLでユーザを作成するコマンドは、grant文です。grant文は、本来ならユーザに特定の権限を与えるための文です。けれども、ユーザが存在しない場合に、grant文でユーザを指定して権限を与えるとユーザが作成されます。MySQLでは、ユーザに権限を与えることでユーザが新規に作成されると考えてください。

###一般的ユーザの権限

　一般的なユーザは、次のような権限を持つユーザだと考えてよいと思います。

|権限|説明|
|select|select文を使用して、データを取得できる|
|insert|insert文を使用して、データを挿入できる|
|delete|delete文を使用して、データを削除できる|
|update|update文を使用して、データを更新できる|
|create|create文を使用して、テーブルを作成できる|
|drop|drop文を使用して、テーブルを削除できる|
|alter|alter文を使用して、テーブルの定義を変更できる|
|index|index文を使用して、インデックスを作成できる|

###grant文で一般ユーザを作成する

　grant文は以下のようになります。だいぶややこしいです。権限のリストには、上で解説した権限をカンマで区切って並べます。データベース名は、権限を与える対象のデータベース名を指定します。

　ユーザ名は username@hostnameのようにホスト名を含んだユーザ名を指定します。パスワードには、password関数を使わないで、平文でパスワードを設定します。grant文では、自動的にpassword関数が適用されるので使用する必要がありません。

```
grant 権限のリスト on データベース名(orテーブル名 ) to ユーザ名(ホスト名含む) identified by 'パスワード';
```

設定例を書いておきます。*.*はすべてのデータベースのすべてのテーブルという意味になります。

```
grant select,insert,delete,update,create,drop,alter,index on *.* to mysqluser@localhost identified by 'honyarara';
```

　grant文を実行した後は反映させるために以下のコマンドを打ちます。

```
flush privileges;
```

###ユーザ名と権限の確認

　ユーザに与えられた権限を確認するには以下のようにします。

```
show grants for ユーザ名(ホスト名を含む);
```

　出力結果の1行目の「grant usage on ～」というのは、権限が何もないという意味です。２行目が実際に与えた権限になっています。

###権限の削除

　権限の削除は、revoke文を使用します。使用方法は、grant文とほぼ同じです。to が fromに変わるだけです。パスワードは必要ありません。一般ユーザの権限を消してみます。

```
revoke select,insert,delete,update,create,drop,alter,index on *.* from mysqluser@localhost;
```

###ユーザーの確認
　mysqlというデータベースのuserテーブルにユーザーの情報が格納されています。userとhostという列を確認して、どのようなユーザがいるかを見てみましょう。

```
select host, user from mysql.user;
```

　以下のように出力されます。
```
+-----------+---------+
| host      | user    |
+-----------+---------+
| 127.0.0.1 | root    |
| centos    |         |
| centos    | root    |
| localhost |         |
| localhost | appuser |
| localhost | manager |
| localhost | root    |
+-----------+---------+
```

　ここで注意したいのはMySQLのユーザーというのは、ユーザー名が一意になっているわけではないということです。接続元のホスト名(あるいはIPアドレス)とユーザ名の組み合わせが一意なものになっています。つまり同じユーザであっても、接続元の違いによって異なる権限を与えることが可能だということです。
